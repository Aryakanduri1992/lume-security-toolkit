# Lume Security Toolkit v0.4.0 - Plugin Architecture Specification

## ğŸ“‹ Document Information

**Version**: 0.4.0  
**Status**: Specification  
**Date**: February 2026  
**Author**: Arya Kanduri  
**Previous Version**: 0.3.0 (ML-Enhanced)  

---

## ğŸ¯ Executive Summary

### **Objective**
Transform Lume from a monolithic tool into a modular plugin-based framework while maintaining 100% backward compatibility with v0.3.0.

### **Core Principle**
> "Minimal, secure, and lean. Not Kubernetes."

### **Key Goals**
1. âœ… Modular plugin architecture
2. âœ… Enhanced security (command template locking)
3. âœ… 100% backward compatibility
4. âœ… Foundation for v0.5.0 workflows
5. âœ… Simple, maintainable codebase

### **Non-Goals**
âŒ Plugin marketplace  
âŒ Dynamic plugin loading  
âŒ Dependency injection frameworks  
âŒ Complex abstractions  
âŒ Over-engineering  

---

## ğŸ—ï¸ Architecture Overview

### **Current Architecture (v0.3.0)**

```
User Input
    â†“
ML Normalizer (optional)
    â†“
Rule Engine (rules.json)
    â†“
Command String
    â†“
subprocess.run(shell=True)  âš ï¸ Security risk
```

### **New Architecture (v0.4.0)**

```
User Input
    â†“
ML Normalizer (optional)
    â†“
Legacy Adapter (backward compatibility)
    â†“
Plugin Registry
    â†“
BasePlugin (secure execution)
    â†“
subprocess.run(shell=False)  âœ… Secure
```

---

## ğŸ“¦ Core Components

### **1. BasePlugin (Abstract Class)**

**Purpose**: Define secure plugin interface

**Location**: `lume/core/plugin_base.py`

**Size**: ~100 lines

**Key Features**:
- Abstract methods for plugin implementation
- Command template enforcement
- Target validation
- Secure execution (shell=False)
- Explanation support

**Interface**:
```python
class BasePlugin(ABC):
    @property
    @abstractmethod
    def name(self) -> str:
        """Plugin name (e.g., 'nmap')"""
        pass
    
    @property
    @abstractmethod
    def command_template(self) -> List[str]:
        """Command template with placeholders
        Example: ["nmap", "-sV", "-T4", "{target}"]
        """
        pass
    
    @abstractmethod
    def validate_target(self, target: str) -> bool:
        """Validate target is safe"""
        pass
    
    @abstractmethod
    def build_command(self, target: str, **kwargs) -> List[str]:
        """Build command from template"""
        pass
    
    @abstractmethod
    def explain(self, target: str) -> Dict[str, str]:
        """Return explanation dict"""
        pass
    
    def execute(self, target: str, dry_run: bool = False) -> Dict:
        """Execute command securely (FINAL method)"""
        # Validates, builds, executes with shell=False
        pass
```

**Security Features**:
- âœ… Command template locking
- âœ… No shell=True execution
- âœ… Target validation required
- âœ… No string concatenation
- âœ… Whitelist-only approach

---

### **2. PluginRegistry (Simple Registry)**

**Purpose**: Manage plugin registration and discovery

**Location**: `lume/core/plugin_registry.py`

**Size**: ~80 lines

**Key Features**:
- Explicit plugin registration
- Simple dictionary storage
- No dynamic loading
- Validation on registration

**Interface**:
```python
class PluginRegistry:
    _plugins: Dict[str, BasePlugin] = {}
    
    @classmethod
    def register(cls, plugin: BasePlugin) -> None:
        """Register a plugin"""
        if not cls._validate_plugin(plugin):
            raise ValueError(f"Invalid plugin: {plugin.name}")
        cls._plugins[plugin.name] = plugin
    
    @classmethod
    def get(cls, name: str) -> Optional[BasePlugin]:
        """Get plugin by name"""
        return cls._plugins.get(name)
    
    @classmethod
    def list_all(cls) -> List[str]:
        """List all plugin names"""
        return list(cls._plugins.keys())
    
    @classmethod
    def _validate_plugin(cls, plugin: BasePlugin) -> bool:
        """Validate plugin meets requirements"""
        # Check required methods exist
        # Check command_template is list
        # Check no shell commands
        pass
```

**Design Principles**:
- âœ… Simple dictionary-based
- âœ… Explicit registration only
- âœ… No auto-discovery
- âœ… Validation on registration
- âœ… Internal-only (no external plugins)

---

### **3. Validators (Security Utilities)**

**Purpose**: Provide validation utilities

**Location**: `lume/core/validators.py`

**Size**: ~80 lines

**Key Functions**:
```python
def validate_ip(target: str) -> bool:
    """Validate IP address"""
    pass

def validate_domain(target: str) -> bool:
    """Validate domain name"""
    pass

def validate_url(target: str) -> bool:
    """Validate URL"""
    pass

def validate_command_template(template: List[str]) -> bool:
    """Validate command template is safe"""
    # Check no shell operators
    # Check no pipes
    # Check no semicolons
    pass

def sanitize_target(target: str) -> str:
    """Sanitize target string"""
    # Remove dangerous characters
    pass
```

---

### **4. Legacy Adapter (Backward Compatibility)**

**Purpose**: Maintain v0.3.0 CLI compatibility

**Location**: `lume/core/legacy_adapter.py`

**Size**: ~60 lines

**Key Features**:
- Translates old commands to new plugins
- Preserves existing behavior
- Transparent to users

**Interface**:
```python
class LegacyAdapter:
    def __init__(self, engine: LumeEngine, registry: PluginRegistry):
        self.engine = engine
        self.registry = registry
    
    def execute(self, instruction: str) -> Dict:
        """Execute legacy instruction via plugins"""
        # 1. Parse with existing engine
        result = self.engine.parse_instruction(instruction)
        
        # 2. Get plugin
        plugin = self.registry.get(result['tool'])
        
        # 3. Execute via plugin
        return plugin.execute(result['target'])
```

---

## ğŸ”Œ Plugin Implementations

### **Plugin Structure**

Each plugin follows this structure:

**Location**: `lume/plugins/{tool_name}.py`

**Size**: ~80 lines each

**Example (Nmap Plugin)**:
```python
from lume.core.plugin_base import BasePlugin
from lume.core.validators import validate_ip, validate_domain

class NmapPlugin(BasePlugin):
    @property
    def name(self) -> str:
        return "nmap"
    
    @property
    def command_template(self) -> List[str]:
        return ["nmap", "-sV", "-T4", "{target}"]
    
    def validate_target(self, target: str) -> bool:
        return validate_ip(target) or validate_domain(target)
    
    def build_command(self, target: str, **kwargs) -> List[str]:
        # Replace {target} in template
        return [arg.replace("{target}", target) 
                for arg in self.command_template]
    
    def explain(self, target: str) -> Dict[str, str]:
        return {
            'summary': 'Performed a service and version scan',
            'impact': 'Identified open ports and services',
            'warning': 'Port scanning may trigger IDS/IPS'
        }
```

### **Plugins to Migrate (7 Total)**

1. **NmapPlugin** - Network scanning
2. **GobusterPlugin** - Directory/subdomain enumeration
3. **NiktoPlugin** - Web vulnerability scanning
4. **SqlmapPlugin** - SQL injection testing
5. **HydraPlugin** - Password brute-forcing
6. **MetasploitPlugin** - Exploitation framework
7. **WhatwebPlugin** - Web technology identification

---

## ğŸ”’ Security Model

### **Command Template Locking**

**Problem**: String concatenation allows injection
```python
# BAD (v0.3.0)
command = f"nmap -sV {target}"  # Injection risk!
subprocess.run(command, shell=True)
```

**Solution**: Template-based with shell=False
```python
# GOOD (v0.4.0)
template = ["nmap", "-sV", "-T4", "{target}"]
command = [arg.replace("{target}", validated_target) for arg in template]
subprocess.run(command, shell=False)  # Safe!
```

### **Security Guarantees**

1. âœ… **No shell=True execution**
   - All commands use shell=False
   - No shell interpretation
   - No pipe/semicolon execution

2. âœ… **Command template locking**
   - Templates are fixed lists
   - No dynamic flag injection
   - Whitelist-only approach

3. âœ… **Target validation**
   - All targets validated before use
   - Dangerous characters removed
   - Type checking (IP/domain/URL)

4. âœ… **No string concatenation**
   - Commands built from lists
   - No f-strings for commands
   - No + operator for commands

5. âœ… **Explicit registration**
   - No dynamic plugin loading
   - No arbitrary code execution
   - Internal plugins only

---

## ğŸ”„ Migration Strategy

### **Phase 1: Foundation (Week 1)**

**Tasks**:
1. Create `plugin_base.py`
2. Create `plugin_registry.py`
3. Create `validators.py`
4. Write unit tests

**Deliverables**:
- Core plugin system
- Test suite
- Documentation

---

### **Phase 2: Plugin Migration (Week 2)**

**Tasks**:
1. Migrate nmap to plugin
2. Migrate gobuster to plugin
3. Migrate nikto to plugin
4. Migrate sqlmap to plugin
5. Migrate hydra to plugin
6. Migrate metasploit to plugin
7. Migrate whatweb to plugin

**Deliverables**:
- 7 plugin files
- Plugin tests
- Plugin documentation

---

### **Phase 3: Integration (Week 3)**

**Tasks**:
1. Create legacy adapter
2. Update CLI to support plugins
3. Maintain backward compatibility
4. Integration testing

**Deliverables**:
- Legacy adapter
- Updated CLI
- Integration tests
- Migration guide

---

### **Phase 4: Polish (Week 4)**

**Tasks**:
1. Security audit
2. Performance testing
3. Documentation finalization
4. Release preparation

**Deliverables**:
- Security audit report
- Performance benchmarks
- Complete documentation
- v0.4.0 release

---

## ğŸ“ File Structure

### **New Files to Create**

```
lume_security_toolkit/
â”œâ”€â”€ lume/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ plugin_base.py          # NEW (~100 lines)
â”‚   â”‚   â”œâ”€â”€ plugin_registry.py      # NEW (~80 lines)
â”‚   â”‚   â”œâ”€â”€ validators.py           # NEW (~80 lines)
â”‚   â”‚   â””â”€â”€ legacy_adapter.py       # NEW (~60 lines)
â”‚   â”‚
â”‚   â””â”€â”€ plugins/                    # NEW DIRECTORY
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ nmap.py                 # NEW (~80 lines)
â”‚       â”œâ”€â”€ gobuster.py             # NEW (~80 lines)
â”‚       â”œâ”€â”€ nikto.py                # NEW (~80 lines)
â”‚       â”œâ”€â”€ sqlmap.py               # NEW (~80 lines)
â”‚       â”œâ”€â”€ hydra.py                # NEW (~80 lines)
â”‚       â”œâ”€â”€ metasploit.py           # NEW (~80 lines)
â”‚       â””â”€â”€ whatweb.py              # NEW (~80 lines)
â”‚
â”œâ”€â”€ tests/                          # NEW DIRECTORY
â”‚   â”œâ”€â”€ test_plugin_base.py         # NEW (~100 lines)
â”‚   â”œâ”€â”€ test_plugin_registry.py     # NEW (~80 lines)
â”‚   â”œâ”€â”€ test_validators.py          # NEW (~80 lines)
â”‚   â”œâ”€â”€ test_legacy_adapter.py      # NEW (~60 lines)
â”‚   â””â”€â”€ test_plugins/
â”‚       â”œâ”€â”€ test_nmap.py            # NEW (~60 lines)
â”‚       â””â”€â”€ ... (6 more)
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ V0.4.0_ARCHITECTURE.md      # NEW
    â”œâ”€â”€ V0.4.0_MIGRATION_GUIDE.md   # NEW
    â””â”€â”€ V0.4.0_PLUGIN_GUIDE.md      # NEW
```

### **Files to Modify**

```
lume/
â”œâ”€â”€ __init__.py                     # Update version to 0.4.0
â”œâ”€â”€ cli.py                          # Add plugin support (minimal changes)
â””â”€â”€ core/
    â””â”€â”€ engine.py                   # Preserve for legacy support
```

---

## ğŸ§ª Testing Strategy

### **Unit Tests**

**Test Coverage**:
- BasePlugin interface
- PluginRegistry operations
- Validator functions
- Each plugin individually
- Legacy adapter

**Test Files**:
- `test_plugin_base.py`
- `test_plugin_registry.py`
- `test_validators.py`
- `test_legacy_adapter.py`
- `test_plugins/test_{tool}.py` (7 files)

### **Integration Tests**

**Test Scenarios**:
1. Legacy command still works
2. Plugin execution works
3. ML + Plugin integration works
4. Error handling works
5. Security validation works

**Test File**:
- `test_integration.py`

### **Security Tests**

**Test Cases**:
1. Command injection prevention
2. Shell=False enforcement
3. Target validation
4. Template locking
5. No dangerous operators

**Test File**:
- `test_security.py`

---

## ğŸ“Š Code Metrics

### **Estimated Lines of Code**

| Component | Lines | Files |
|-----------|-------|-------|
| Core Plugin System | 320 | 4 |
| Plugin Implementations | 560 | 7 |
| Tests | 600 | 10 |
| Documentation | 800 | 3 |
| **TOTAL** | **2,280** | **24** |

### **Comparison to v0.3.0**

| Metric | v0.3.0 | v0.4.0 | Change |
|--------|--------|--------|--------|
| Core Code | 1,750 | 880 | -870 (refactored) |
| Plugin Code | 0 | 560 | +560 (new) |
| Tests | 150 | 600 | +450 (expanded) |
| Docs | 1,200 | 800 | +800 (new) |
| **Total** | **3,100** | **2,840** | **-260** |

**Note**: Total lines decrease due to refactoring, but functionality increases.

---

## ğŸ¯ Success Criteria

### **Functional Requirements**

âœ… All v0.3.0 commands work identically  
âœ… 7 plugins implemented and tested  
âœ… Plugin registry operational  
âœ… Legacy adapter functional  
âœ… Security model enforced  

### **Non-Functional Requirements**

âœ… No shell=True anywhere in codebase  
âœ… 85%+ test coverage  
âœ… All tests passing  
âœ… Documentation complete  
âœ… Security audit passed  

### **User Experience**

âœ… Backward compatible (users see no difference)  
âœ… New plugin CLI optional  
âœ… Clear error messages  
âœ… Performance maintained  

---

## ğŸš€ Implementation Checklist

### **Week 1: Foundation**

- [ ] Create `lume/core/plugin_base.py`
- [ ] Create `lume/core/plugin_registry.py`
- [ ] Create `lume/core/validators.py`
- [ ] Write unit tests for core
- [ ] Document core architecture

### **Week 2: Plugins**

- [ ] Create `lume/plugins/` directory
- [ ] Implement NmapPlugin
- [ ] Implement GobusterPlugin
- [ ] Implement NiktoPlugin
- [ ] Implement SqlmapPlugin
- [ ] Implement HydraPlugin
- [ ] Implement MetasploitPlugin
- [ ] Implement WhatwebPlugin
- [ ] Write plugin tests

### **Week 3: Integration**

- [ ] Create `lume/core/legacy_adapter.py`
- [ ] Update `lume/cli.py` for plugin support
- [ ] Test backward compatibility
- [ ] Write integration tests
- [ ] Update documentation

### **Week 4: Polish**

- [ ] Security audit
- [ ] Performance testing
- [ ] Fix any issues
- [ ] Finalize documentation
- [ ] Prepare release notes
- [ ] Tag v0.4.0
- [ ] Push to GitHub

---

## ğŸ“ CLI Examples

### **Backward Compatible (v0.3.0 style)**

```bash
# These still work exactly the same
lume "scan ports on 192.168.1.1"
lume "find directories on example.com"
lume --explain "test sql injection on target.com"
lume --dry-run "brute force ssh on 192.168.1.10"
```

### **New Plugin CLI (v0.4.0 optional)**

```bash
# List available plugins
lume --list-plugins

# Get plugin info
lume --plugin-info nmap

# Use plugin directly (optional)
lume --plugin nmap --target 192.168.1.1
```

---

## ğŸ”® Future Roadmap

### **v0.5.0 - Workflows (Next)**

**Foundation**: Plugin architecture enables workflows

**Features**:
- BaseWorkflow abstract class
- WorkflowExecutor
- 3 initial workflows (web, network, password)

**Timeline**: 2-3 weeks after v0.4.0

### **v1.0.0 - Academic Extension (Future)**

**Foundation**: Workflows enable lab structure

**Features**:
- Domain â†’ Lab â†’ Experiment hierarchy
- Faculty controls
- Student progress tracking
- Educational platform

**Timeline**: 4-6 weeks after v0.5.0

---

## âš ï¸ Critical Warnings

### **DO NOT**

âŒ Add plugin marketplace  
âŒ Implement dynamic loading  
âŒ Use dependency injection frameworks  
âŒ Over-abstract the design  
âŒ Break backward compatibility  
âŒ Allow shell=True anywhere  
âŒ Skip security validation  

### **MUST DO**

âœ… Keep it simple and lean  
âœ… Maintain backward compatibility  
âœ… Enforce security at every layer  
âœ… Test thoroughly  
âœ… Document clearly  
âœ… Stay focused on v0.4.0 scope  

---

## ğŸ“š Documentation Requirements

### **Technical Documentation**

1. **V0.4.0_ARCHITECTURE.md**
   - System architecture
   - Component descriptions
   - Security model
   - Design decisions

2. **V0.4.0_PLUGIN_GUIDE.md**
   - How to create plugins
   - Plugin interface reference
   - Security requirements
   - Examples

3. **V0.4.0_MIGRATION_GUIDE.md**
   - Migration from v0.3.0
   - Breaking changes (none expected)
   - New features
   - Examples

### **User Documentation**

1. **README.md** (update)
   - Add v0.4.0 features
   - Update examples
   - Add plugin information

2. **CHANGELOG.md** (update)
   - Add v0.4.0 release notes
   - List new features
   - Document changes

---

## ğŸ¯ Definition of Done

**v0.4.0 is complete when:**

âœ… All code written and reviewed  
âœ… All tests passing (85%+ coverage)  
âœ… Security audit completed  
âœ… Documentation finalized  
âœ… Backward compatibility verified  
âœ… Performance benchmarks acceptable  
âœ… Release notes written  
âœ… Tagged and pushed to GitHub  
âœ… No known critical bugs  
âœ… Ready for production use  

---

## ğŸ“ Support & Questions

**For Implementation Questions**:
- Review this specification
- Check existing v0.3.0 code
- Refer to security model section
- Keep it simple and lean

**For Architecture Decisions**:
- Follow "minimal but secure" principle
- Avoid over-engineering
- Maintain backward compatibility
- Prioritize security

---

## âœ… Approval & Sign-Off

**Specification Status**: âœ… APPROVED

**Key Principles Confirmed**:
- âœ… Minimal, secure, lean
- âœ… No over-engineering
- âœ… Backward compatible
- âœ… Foundation for future growth

**Ready for Implementation**: âœ… YES

**Next Step**: Begin Week 1 implementation in fresh conversation

---

**Version**: 0.4.0-spec  
**Date**: February 2026  
**Author**: Arya Kanduri  
**Status**: Ready for Implementation  

**"Think in English. Hack in Kali. Build it Lean."** ğŸ”¦
